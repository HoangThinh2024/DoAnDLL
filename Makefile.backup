# ğŸ’Š Smart Pill Recognition System - Makefile
# Tá»‘i Æ°u cho UV Package Manager

.PHONY: help install install-dev install-gpu run train test clean lint format setup-env docker-build docker-run monitor deploy status

# Default target
.DEFAULT_GOAL := help

# Colors for output
BLUE := \033[0;34m
GREEN := \033[0;32m
YELLOW := \033[1;33m
RED := \033[0;31m
NC := \033[0m # No Color

# Project info
PROJECT_NAME := pill-recognition-system
PYTHON_VERSION := 3.10
VENV_NAME := .venv

help: ## ğŸ“š Hiá»ƒn thá»‹ menu trá»£ giÃºp
	@echo "$(BLUE)ï¿½ Smart Pill Recognition System - UV Commands$(NC)"
	@echo "=================================================="
	@echo ""
	@grep -E '^[a-zA-Z_-]+:.*?## .*$$' $(MAKEFILE_LIST) | sort | awk 'BEGIN {FS = ":.*?## "}; {printf "$(YELLOW)  %-20s$(NC) %s\n", $$1, $$2}'
	@echo ""
	@echo "$(GREEN)ğŸš€ Quick Start:$(NC)"
	@echo "  make setup        # CÃ i Ä‘áº·t hoÃ n chá»‰nh"
	@echo "  make install      # CÃ i Ä‘áº·t dependencies"
	@echo "  make run          # Cháº¡y web app"
	@echo "  make test         # Cháº¡y tests"

# ================================
# ğŸ—ï¸ Setup & Installation
# ================================

setup: ## ğŸ—ï¸ CÃ i Ä‘áº·t hoÃ n chá»‰nh (UV + venv + dependencies)
	@echo "$(BLUE)ğŸš€ Setting up Pill Recognition System with UV...$(NC)"
	./bin/pill-setup

setup-env: ## ğŸ”§ Táº¡o mÃ´i trÆ°á»ng áº£o vá»›i UV
	@echo "$(BLUE)ğŸ“¦ Creating virtual environment with UV...$(NC)"
	@if ! command -v uv > /dev/null; then \
		echo "$(YELLOW)âš ï¸  UV not found, installing...$(NC)"; \
		curl -LsSf https://astral.sh/uv/install.sh | sh; \
		export PATH="$$HOME/.cargo/bin:$$PATH"; \
	fi
	@if [ -d "$(VENV_NAME)" ]; then \
		echo "$(YELLOW)ğŸ—‘ï¸  Removing existing virtual environment...$(NC)"; \
		rm -rf $(VENV_NAME); \
	fi
	uv venv $(VENV_NAME) --python $(PYTHON_VERSION)
	@echo "$(GREEN)âœ… Virtual environment created: $(VENV_NAME)$(NC)"

install: setup-env ## ğŸ“¦ CÃ i Ä‘áº·t dependencies cÆ¡ báº£n
	@echo "$(BLUE)ï¿½ Installing core dependencies with UV...$(NC)"
	. $(VENV_NAME)/bin/activate && uv pip install -e .
	@echo "$(GREEN)âœ… Core installation complete!$(NC)"
	uv venv --python 3.8
	uv pip install -e .
	@echo "âœ… Installation complete!"

# Install with GPU support
install-gpu: install
	@echo "ğŸ® Installing GPU dependencies..."
	uv pip install "cudf-cu11>=23.06.0" "cuml-cu11>=23.06.0" "cupy-cuda11x>=12.0.0" || echo "âš ï¸ GPU dependencies failed (normal without NVIDIA GPU)"

# Run Streamlit app
run:
	@echo "ğŸŒ Starting Streamlit app..."
	@echo "Open your browser at: http://localhost:8501"
	streamlit run app.py

# Run training
train:
	@echo "ğŸ‹ï¸ Starting model training..."
	python src/training/trainer.py

# Start Jupyter Lab
notebook:
	@echo "ğŸ““ Starting Jupyter Lab..."
	uv pip install jupyterlab
	jupyter lab --ip=0.0.0.0 --port=8888 --no-browser --allow-root

# Run tests
test:
	@echo "ğŸ§ª Running tests..."
	uv pip install pytest pytest-cov
	pytest tests/ -v --cov=src

# Lint code
lint:
	@echo "ğŸ” Running linting..."
	uv pip install flake8 mypy
	flake8 src/ app.py
	mypy src/ --ignore-missing-imports

# Format code
format:
	@echo "âœ¨ Formatting code..."
	uv pip install black isort
	black src/ app.py
	isort src/ app.py

# Clean cache and temporary files
clean:
	@echo "ğŸ§¹ Cleaning up..."
	find . -type d -name "__pycache__" -exec rm -rf {} +
	find . -type f -name "*.pyc" -delete
	find . -type f -name "*.pyo" -delete
	find . -type d -name "*.egg-info" -exec rm -rf {} +
	rm -rf .pytest_cache
	rm -rf .coverage
	rm -rf dist/
	rm -rf build/

# Build Docker image
docker-build:
	@echo "ğŸ³ Building Docker image..."
	docker build -t pill-recognition .

# Run with Docker
docker-run:
	@echo "ğŸš€ Running with Docker..."
	docker run -p 8501:8501 -v $(PWD)/data:/app/data pill-recognition

# Full setup (alternative to scripts)
setup: install
	@echo "ğŸ“ Creating directories..."
	mkdir -p data/raw data/processed checkpoints logs results
	@echo "ğŸ‰ Setup complete! Run 'make run' to start the app."

# Development setup
dev-setup: install
	@echo "ğŸ› ï¸ Setting up development environment..."
	uv pip install -e ".[dev]"
	pre-commit install
	@echo "âœ… Development setup complete!"

# Check system
check:
	@echo "ğŸ” Checking system capabilities..."
	@python -c "import torch; print(f'PyTorch: {torch.__version__}'); print(f'CUDA: {torch.cuda.is_available()}')"
	@uv --version
	@echo "âœ… System check complete!"

# Setup Ubuntu 22.04 environment
setup:
	@echo "ğŸ”§ Setting up Ubuntu 22.04 environment..."
	chmod +x setup_ubuntu22.sh
	sudo ./setup_ubuntu22.sh

# Test GPU functionality
gpu-test:
	@echo "ğŸ® Testing GPU functionality..."
	chmod +x start.sh
	./start.sh test

# Monitor GPU usage
monitor:
	@echo "ğŸ“Š Starting GPU monitoring..."
	chmod +x monitor_gpu.sh
	./monitor_gpu.sh monitor

# Deploy for production
deploy:
	@echo "ğŸš€ Deploying for production..."
	chmod +x deploy_ubuntu22.sh
	./deploy_ubuntu22.sh

# Optimize GPU settings
optimize:
	@echo "âš¡ Optimizing GPU settings..."
	chmod +x monitor_gpu.sh
	sudo ./monitor_gpu.sh optimize

# Verify CUDA 12.8 installation
cuda-verify:
	@echo "ğŸ”§ Verifying CUDA 12.8 installation..."
	chmod +x verify_cuda128.sh
	./verify_cuda128.sh
