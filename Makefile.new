# ğŸ’Š Smart Pill Recognition System - Makefile
# Tá»‘i Æ°u cho UV Package Manager

.PHONY: help install install-dev install-gpu run train test clean lint format setup-env docker-build docker-run monitor deploy status

# Default target
.DEFAULT_GOAL := help

# Colors for output
BLUE := \033[0;34m
GREEN := \033[0;32m
YELLOW := \033[1;33m
RED := \033[0;31m
NC := \033[0m # No Color

# Project info
PROJECT_NAME := pill-recognition-system
PYTHON_VERSION := 3.10
VENV_NAME := .venv

help: ## ğŸ“š Hiá»ƒn thá»‹ menu trá»£ giÃºp
	@echo "$(BLUE)ğŸ’Š Smart Pill Recognition System - UV Commands$(NC)"
	@echo "=================================================="
	@echo ""
	@grep -E '^[a-zA-Z_-]+:.*?## .*$$' $(MAKEFILE_LIST) | sort | awk 'BEGIN {FS = ":.*?## "}; {printf "$(YELLOW)  %-20s$(NC) %s\n", $$1, $$2}'
	@echo ""
	@echo "$(GREEN)ğŸš€ Quick Start:$(NC)"
	@echo "  make setup        # CÃ i Ä‘áº·t hoÃ n chá»‰nh"
	@echo "  make install      # CÃ i Ä‘áº·t dependencies"
	@echo "  make run          # Cháº¡y web app"
	@echo "  make test         # Cháº¡y tests"

# ================================
# ğŸ—ï¸ Setup & Installation
# ================================

setup: ## ğŸ—ï¸ CÃ i Ä‘áº·t hoÃ n chá»‰nh (UV + venv + dependencies)
	@echo "$(BLUE)ğŸš€ Setting up Pill Recognition System with UV...$(NC)"
	./bin/pill-setup

setup-env: ## ğŸ”§ Táº¡o mÃ´i trÆ°á»ng áº£o vá»›i UV
	@echo "$(BLUE)ğŸ“¦ Creating virtual environment with UV...$(NC)"
	@if ! command -v uv > /dev/null; then \
		echo "$(YELLOW)âš ï¸  UV not found, installing...$(NC)"; \
		curl -LsSf https://astral.sh/uv/install.sh | sh; \
		export PATH="$$HOME/.cargo/bin:$$PATH"; \
	fi
	@if [ -d "$(VENV_NAME)" ]; then \
		echo "$(YELLOW)ğŸ—‘ï¸  Removing existing virtual environment...$(NC)"; \
		rm -rf $(VENV_NAME); \
	fi
	uv venv $(VENV_NAME) --python $(PYTHON_VERSION)
	@echo "$(GREEN)âœ… Virtual environment created: $(VENV_NAME)$(NC)"

install: setup-env ## ğŸ“¦ CÃ i Ä‘áº·t dependencies cÆ¡ báº£n
	@echo "$(BLUE)ğŸ“š Installing core dependencies with UV...$(NC)"
	. $(VENV_NAME)/bin/activate && uv pip install -e .
	@echo "$(GREEN)âœ… Core installation complete!$(NC)"

install-dev: install ## ğŸ‘¨â€ğŸ’» CÃ i Ä‘áº·t dependencies cho development
	@echo "$(BLUE)ğŸ› ï¸ Installing development dependencies...$(NC)"
	. $(VENV_NAME)/bin/activate && uv pip install -e ".[dev]"
	@echo "$(GREEN)âœ… Development installation complete!$(NC)"

install-gpu: install ## ğŸ® CÃ i Ä‘áº·t dependencies GPU
	@echo "$(BLUE)ğŸ® Installing GPU dependencies...$(NC)"
	. $(VENV_NAME)/bin/activate && uv pip install -e ".[gpu]"
	. $(VENV_NAME)/bin/activate && uv pip install torch torchvision torchaudio --index-url https://download.pytorch.org/whl/cu121
	@echo "$(GREEN)âœ… GPU installation complete!$(NC)"

install-all: install ## ğŸŒŸ CÃ i Ä‘áº·t táº¥t cáº£ dependencies
	@echo "$(BLUE)ğŸŒŸ Installing all optional dependencies...$(NC)"
	. $(VENV_NAME)/bin/activate && uv pip install -e ".[all]"
	@echo "$(GREEN)âœ… Full installation complete!$(NC)"

# ================================
# ğŸš€ Running Applications
# ================================

run: ## ğŸŒ Cháº¡y Streamlit web app
	@echo "$(BLUE)ğŸŒ Starting Streamlit app...$(NC)"
	@echo "$(GREEN)â¡ï¸  Open your browser at: http://localhost:8501$(NC)"
	. $(VENV_NAME)/bin/activate && streamlit run apps/web/streamlit_app.py

cli: ## ğŸ–¥ï¸ Cháº¡y CLI interface
	@echo "$(BLUE)ğŸ–¥ï¸ Starting CLI interface...$(NC)"
	. $(VENV_NAME)/bin/activate && python apps/cli/main.py

train: ## ğŸ‹ï¸ Huáº¥n luyá»‡n model
	@echo "$(BLUE)ğŸ‹ï¸ Starting model training...$(NC)"
	. $(VENV_NAME)/bin/activate && python -m core.training.trainer

recognize: ## ğŸ” Nháº­n dáº¡ng áº£nh (example)
	@echo "$(BLUE)ğŸ” Running pill recognition example...$(NC)"
	@if [ -f "Dataset_BigData/CURE_dataset/CURE_dataset_test/0_bottom_24.jpg" ]; then \
		. $(VENV_NAME)/bin/activate && python main.py recognize Dataset_BigData/CURE_dataset/CURE_dataset_test/0_bottom_24.jpg; \
	else \
		echo "$(YELLOW)âš ï¸  Demo image not found$(NC)"; \
	fi

# ================================
# ğŸ§ª Testing & Quality
# ================================

test: ## ğŸ§ª Cháº¡y tests
	@echo "$(BLUE)ğŸ§ª Running tests with pytest...$(NC)"
	. $(VENV_NAME)/bin/activate && pytest tests/ -v --cov=core --cov=apps

test-fast: ## âš¡ Cháº¡y tests nhanh (bá» qua slow tests)
	@echo "$(BLUE)âš¡ Running fast tests...$(NC)"
	. $(VENV_NAME)/bin/activate && pytest tests/ -v -m "not slow"

test-gpu: ## ğŸ® Cháº¡y GPU tests
	@echo "$(BLUE)ğŸ® Running GPU tests...$(NC)"
	. $(VENV_NAME)/bin/activate && pytest tests/ -v -m "gpu"

lint: ## ğŸ” Cháº¡y linting
	@echo "$(BLUE)ğŸ” Running linting...$(NC)"
	. $(VENV_NAME)/bin/activate && flake8 core apps tests
	. $(VENV_NAME)/bin/activate && mypy core apps

format: ## âœ¨ Format code
	@echo "$(BLUE)âœ¨ Formatting code...$(NC)"
	. $(VENV_NAME)/bin/activate && black core apps tests --line-length 100
	. $(VENV_NAME)/bin/activate && isort core apps tests --profile black

format-check: ## ğŸ” Kiá»ƒm tra format code
	@echo "$(BLUE)ğŸ” Checking code format...$(NC)"
	. $(VENV_NAME)/bin/activate && black --check core apps tests --line-length 100
	. $(VENV_NAME)/bin/activate && isort --check-only core apps tests --profile black

# ================================
# ğŸ“Š Development Tools
# ================================

notebook: ## ğŸ““ Cháº¡y Jupyter Lab
	@echo "$(BLUE)ğŸ““ Starting Jupyter Lab...$(NC)"
	. $(VENV_NAME)/bin/activate && uv pip install jupyterlab
	. $(VENV_NAME)/bin/activate && jupyter lab --ip=0.0.0.0 --port=8888 --no-browser

monitor: ## ğŸ“Š Monitor GPU usage
	@echo "$(BLUE)ğŸ“Š Monitoring GPU usage...$(NC)"
	watch -n 1 nvidia-smi

status: ## ğŸ“‹ Hiá»ƒn thá»‹ tráº¡ng thÃ¡i há»‡ thá»‘ng
	@echo "$(BLUE)ğŸ“‹ System Status$(NC)"
	@echo "=================="
	@echo "ğŸ Python: $$(python3 --version 2>/dev/null || echo 'Not found')"
	@echo "ğŸ“¦ UV: $$(uv --version 2>/dev/null || echo 'Not found')"
	@echo "ğŸ—‚ï¸  Virtual Env: $$([ -d '$(VENV_NAME)' ] && echo 'Exists' || echo 'Not found')"
	@echo "ğŸ® GPU: $$(nvidia-smi --query-gpu=name --format=csv,noheader,nounits 2>/dev/null | head -1 || echo 'Not found')"
	@echo "ğŸ’¾ Disk: $$(df -h . | tail -1 | awk '{print $$4}' || echo 'Unknown') available"

# ================================
# ğŸ§¹ Cleanup
# ================================

clean: ## ğŸ§¹ Dá»n dáº¹p cache vÃ  temp files
	@echo "$(BLUE)ğŸ§¹ Cleaning cache and temporary files...$(NC)"
	find . -type d -name "__pycache__" -exec rm -rf {} + 2>/dev/null || true
	find . -type f -name "*.pyc" -delete 2>/dev/null || true
	find . -type f -name "*.pyo" -delete 2>/dev/null || true
	find . -type f -name ".coverage" -delete 2>/dev/null || true
	find . -type d -name ".pytest_cache" -exec rm -rf {} + 2>/dev/null || true
	find . -type d -name ".mypy_cache" -exec rm -rf {} + 2>/dev/null || true
	find . -type d -name "*.egg-info" -exec rm -rf {} + 2>/dev/null || true
	rm -rf build/ dist/ .coverage htmlcov/ .tox/
	@echo "$(GREEN)âœ… Cleanup complete!$(NC)"

clean-env: ## ğŸ—‘ï¸ XÃ³a virtual environment
	@echo "$(BLUE)ğŸ—‘ï¸ Removing virtual environment...$(NC)"
	rm -rf $(VENV_NAME)
	@echo "$(GREEN)âœ… Virtual environment removed!$(NC)"

reset: clean clean-env setup ## ğŸ”„ Reset hoÃ n toÃ n project
	@echo "$(GREEN)ğŸ”„ Project reset complete!$(NC)"

# ================================
# ğŸ³ Docker
# ================================

docker-build: ## ğŸ³ Build Docker image
	@echo "$(BLUE)ğŸ³ Building Docker image...$(NC)"
	docker build -t $(PROJECT_NAME):latest .

docker-run: ## ğŸš€ Cháº¡y vá»›i Docker
	@echo "$(BLUE)ğŸš€ Running with Docker...$(NC)"
	docker run -p 8501:8501 --gpus all $(PROJECT_NAME):latest

docker-clean: ## ğŸ§¹ Dá»n dáº¹p Docker
	@echo "$(BLUE)ğŸ§¹ Cleaning Docker...$(NC)"
	docker system prune -f

# ================================
# ğŸ”§ Utilities
# ================================

requirements: ## ğŸ“‹ Táº¡o requirements.txt tá»« UV
	@echo "$(BLUE)ğŸ“‹ Generating requirements.txt...$(NC)"
	. $(VENV_NAME)/bin/activate && uv pip freeze > requirements.txt

check-deps: ## ğŸ” Kiá»ƒm tra dependencies
	@echo "$(BLUE)ğŸ” Checking dependencies...$(NC)"
	. $(VENV_NAME)/bin/activate && uv pip check

update-deps: ## ğŸ”„ Cáº­p nháº­t dependencies
	@echo "$(BLUE)ğŸ”„ Updating dependencies...$(NC)"
	. $(VENV_NAME)/bin/activate && uv pip install --upgrade pip
	. $(VENV_NAME)/bin/activate && uv pip install -e . --upgrade

# ================================
# ğŸ“Š Information
# ================================

info: ## â„¹ï¸ ThÃ´ng tin project
	@echo "$(BLUE)â„¹ï¸  Project Information$(NC)"
	@echo "========================"
	@echo "ğŸ“› Name: $(PROJECT_NAME)"
	@echo "ğŸ Python: $(PYTHON_VERSION)+"
	@echo "ğŸ“¦ Package Manager: UV"
	@echo "ğŸ—‚ï¸  Virtual Env: $(VENV_NAME)"
	@echo "ğŸŒ Web URL: http://localhost:8501"
	@echo "ğŸ“š Docs: docs/"

show-venv: ## ğŸ” Hiá»ƒn thá»‹ thÃ´ng tin virtual environment
	@echo "$(BLUE)ğŸ” Virtual Environment Info$(NC)"
	@echo "============================="
	@if [ -d "$(VENV_NAME)" ]; then \
		echo "âœ… Status: Active"; \
		echo "ğŸ“ Path: $$(pwd)/$(VENV_NAME)"; \
		echo "ğŸ Python: $$(.venv/bin/python --version)"; \
		echo "ğŸ“¦ Packages: $$(.venv/bin/pip list | wc -l) installed"; \
	else \
		echo "âŒ Status: Not found"; \
		echo "ğŸ’¡ Run 'make setup' to create"; \
	fi
