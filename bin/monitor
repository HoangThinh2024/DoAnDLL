#!/bin/bash

# GPU Monitoring script for Nvidia Quadro 6000
# Monitor GPU usage, temperature, and memory during model training/inference

echo "ðŸŽ® Nvidia Quadro 6000 Monitoring Dashboard"
echo "=========================================="

# Function to get GPU info
get_gpu_info() {
    echo "ðŸ“Š GPU Information:"
    if command -v nvidia-smi &> /dev/null; then
        nvidia-smi --query-gpu=name,driver_version,memory.total,memory.used,memory.free,temperature.gpu,utilization.gpu,utilization.memory --format=csv,noheader,nounits
    else
        echo "âš ï¸  nvidia-smi not found. GPU monitoring not available in this environment."
        echo "System info:"
        echo "CPU: $(nproc) cores"
        echo "Memory: $(free -h | awk '/^Mem:/ {print $2}')"
        echo "OS: $(uname -s) $(uname -r)"
    fi
}

# Function to monitor continuously
monitor_continuous() {
    if ! command -v nvidia-smi &> /dev/null; then
        echo "âš ï¸  nvidia-smi not found. Starting CPU/Memory monitoring instead..."
        echo "ðŸ”„ Starting continuous monitoring (Press Ctrl+C to stop)"
        while true; do
            clear
            echo "ðŸ’» System Monitoring Dashboard (No GPU)"
            echo "Time: $(date)"
            echo "=========================================="
            
            echo "ðŸ“Š CPU Usage:"
            top -bn1 | grep "Cpu(s)" | awk '{print $2}' | cut -d'%' -f1 | awk '{printf "CPU Usage: %.1f%%\n", $1}'
            
            echo ""
            echo "ðŸ’¾ Memory Usage:"
            free -h | awk '/^Mem:/ {printf "Used: %s / %s (%.1f%%)\n", $3, $2, ($3/$2)*100}'
            
            echo ""
            echo "ðŸ”¥ System Load:"
            uptime | awk -F'load average:' '{print "Load Average:" $2}'
            
            echo ""
            echo "ðŸ’½ Disk Usage:"
            df -h | awk '$NF=="/" {printf "Disk Usage: %s / %s (%s)\n", $3, $2, $5}'
            
            sleep 5
        done
        return
    fi
    
    echo "ðŸ”„ Starting continuous monitoring (Press Ctrl+C to stop)"
    while true; do
        clear
        echo "ðŸŽ® Nvidia Quadro 6000 Real-time Monitoring"
        echo "Time: $(date)"
        echo "=========================================="
        
        # GPU Status
        echo "ðŸ“ˆ GPU Status:"
        nvidia-smi --query-gpu=utilization.gpu,utilization.memory,temperature.gpu,power.draw --format=csv,noheader,nounits | \
        awk -F', ' '{printf "GPU Utilization: %s%%\nMemory Utilization: %s%%\nTemperature: %sÂ°C\nPower Draw: %sW\n", $1, $2, $3, $4}'
        
        echo ""
        echo "ðŸ’¾ Memory Usage:"
        nvidia-smi --query-gpu=memory.used,memory.total --format=csv,noheader,nounits | \
        awk -F', ' '{printf "Used: %s MB / %s MB (%.1f%%)\n", $1, $2, ($1/$2)*100}'
        
        echo ""
        echo "ðŸ”¥ Thermal Status:"
        temp=$(nvidia-smi --query-gpu=temperature.gpu --format=csv,noheader,nounits)
        if [ $temp -lt 60 ]; then
            echo "Temperature: ${temp}Â°C âœ… (Normal)"
        elif [ $temp -lt 80 ]; then
            echo "Temperature: ${temp}Â°C âš ï¸  (Warm)"
        else
            echo "Temperature: ${temp}Â°C ðŸ”¥ (Hot - Check cooling!)"
        fi
        
        echo ""
        echo "âš¡ Power Status:"
        power=$(nvidia-smi --query-gpu=power.draw --format=csv,noheader,nounits | cut -d'.' -f1)
        max_power=$(nvidia-smi --query-gpu=power.max_limit --format=csv,noheader,nounits | cut -d'.' -f1)
        power_percent=$(echo "scale=1; $power * 100 / $max_power" | bc)
        echo "Power Draw: ${power}W / ${max_power}W (${power_percent}%)"
        
        echo ""
        echo "ðŸ³ Docker Container GPU Usage:"
        docker stats --no-stream --format "table {{.Container}}\t{{.CPUPerc}}\t{{.MemUsage}}" | grep pill-recognition 2>/dev/null || echo "No pill-recognition containers running"
        
        sleep 5
    done
}

# Function to log GPU stats
log_stats() {
    timestamp=$(date '+%Y-%m-%d %H:%M:%S')
    log_file="logs/gpu_monitoring_$(date +%Y%m%d).log"
    
    mkdir -p logs
    
    echo "[$timestamp] GPU Stats:" >> $log_file
    nvidia-smi --query-gpu=utilization.gpu,utilization.memory,temperature.gpu,power.draw,memory.used,memory.total --format=csv,noheader,nounits >> $log_file
    echo "Logged to $log_file"
}

# Function to check GPU health
check_health() {
    echo "ðŸ¥ System Health Check:"
    
    if ! command -v nvidia-smi &> /dev/null; then
        echo "âš ï¸  nvidia-smi not found - checking system health instead"
        
        # Check CPU temperature (if available)
        if command -v sensors &> /dev/null; then
            temp=$(sensors | grep "Core 0" | awk '{print $3}' | tr -d '+Â°C' 2>/dev/null || echo "N/A")
            if [ "$temp" != "N/A" ] && [ $temp -gt 80 ]; then
                echo "âŒ CPU temperature too high: ${temp}Â°C (>80Â°C)"
            elif [ "$temp" != "N/A" ]; then
                echo "âœ… CPU temperature OK: ${temp}Â°C"
            else
                echo "â„¹ï¸  CPU temperature monitoring not available"
            fi
        else
            echo "â„¹ï¸  Temperature monitoring not available (install lm-sensors)"
        fi
        
        # Check memory usage
        memory_percent=$(free | awk '/^Mem:/ {printf "%.1f", ($3/$2)*100}')
        if (( $(echo "$memory_percent > 90" | bc -l) )); then
            echo "âŒ Memory usage too high: ${memory_percent}%"
        else
            echo "âœ… Memory usage OK: ${memory_percent}%"
        fi
        
        # Check disk space
        disk_percent=$(df / | awk 'NR==2 {print $5}' | tr -d '%')
        if [ $disk_percent -gt 90 ]; then
            echo "âŒ Disk usage too high: ${disk_percent}%"
        else
            echo "âœ… Disk usage OK: ${disk_percent}%"
        fi
        
        echo "âœ… System is accessible (no GPU)"
        return
    fi
    
    # Check temperature
    temp=$(nvidia-smi --query-gpu=temperature.gpu --format=csv,noheader,nounits)
    if [ $temp -gt 85 ]; then
        echo "âŒ Temperature too high: ${temp}Â°C (>85Â°C)"
    else
        echo "âœ… Temperature OK: ${temp}Â°C"
    fi
    
    # Check memory usage
    memory_used=$(nvidia-smi --query-gpu=memory.used --format=csv,noheader,nounits)
    memory_total=$(nvidia-smi --query-gpu=memory.total --format=csv,noheader,nounits)
    memory_percent=$(echo "scale=1; $memory_used * 100 / $memory_total" | bc)
    
    if (( $(echo "$memory_percent > 95" | bc -l) )); then
        echo "âŒ Memory usage too high: ${memory_percent}%"
    else
        echo "âœ… Memory usage OK: ${memory_percent}%"
    fi
    
    # Check if GPU is accessible
    if nvidia-smi > /dev/null 2>&1; then
        echo "âœ… GPU is accessible"
    else
        echo "âŒ GPU not accessible"
    fi
}

# Function to optimize GPU settings
optimize_gpu() {
    if ! command -v nvidia-smi &> /dev/null; then
        echo "âš ï¸  nvidia-smi not found - GPU optimization not available"
        echo "ðŸ”§ Applying general system optimizations instead..."
        
        # CPU governor optimization (if available)
        if [ -f /sys/devices/system/cpu/cpu0/cpufreq/scaling_governor ]; then
            echo "Setting CPU governor to performance mode..."
            echo "performance" | sudo tee /sys/devices/system/cpu/cpu*/cpufreq/scaling_governor > /dev/null 2>&1 || echo "Need sudo privileges for CPU optimization"
        fi
        
        # Adjust swappiness for better performance
        echo "Optimizing memory settings..."
        echo 10 | sudo tee /proc/sys/vm/swappiness > /dev/null 2>&1 || echo "Need sudo privileges for memory optimization"
        
        echo "âœ… System optimizations applied (limited without GPU)"
        return
    fi
    
    echo "ðŸ”§ Applying Quadro 6000 optimizations..."
    
    # Set persistence mode
    sudo nvidia-smi -pm 1
    
    # Set max performance mode
    sudo nvidia-smi -ac 6251,1911
    
    # Set power limit to maximum
    sudo nvidia-smi -pl 300
    
    echo "âœ… GPU optimizations applied"
}

# Main menu
case "$1" in
    "monitor")
        monitor_continuous
        ;;
    "log")
        log_stats
        ;;
    "health")
        check_health
        ;;
    "optimize")
        optimize_gpu
        ;;
    "info")
        get_gpu_info
        ;;
    *)
        echo "Usage: $0 {monitor|log|health|optimize|info}"
        echo ""
        echo "Commands:"
        echo "  monitor  - Start continuous monitoring"
        echo "  log      - Log current stats to file"
        echo "  health   - Check GPU health status"
        echo "  optimize - Apply Quadro 6000 optimizations"
        echo "  info     - Show GPU information"
        exit 1
        ;;
esac
