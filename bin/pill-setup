#!/bin/bash

# ğŸš€ Pill Recognition System - Setup Script
# CÃ i Ä‘áº·t tá»± Ä‘á»™ng vá»›i UV Python Package Manager

set -e  # Exit on any error

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
PURPLE='\033[0;35m'
CYAN='\033[0;36m'
NC='\033[0m' # No Color

# Progress indicator
show_progress() {
    echo -e "${CYAN}ğŸ”„ $1${NC}"
}

show_success() {
    echo -e "${GREEN}âœ… $1${NC}"
}

show_warning() {
    echo -e "${YELLOW}âš ï¸  $1${NC}"
}

show_error() {
    echo -e "${RED}âŒ $1${NC}"
}

show_info() {
    echo -e "${BLUE}â„¹ï¸  $1${NC}"
}

# Navigate to project root
cd "$(dirname "$0")/.."

# Banner
echo -e "${PURPLE}"
cat << "EOF"
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                     â”‚
â”‚   ğŸ’Š Smart Pill Recognition System                 â”‚
â”‚   ğŸš€ CÃ i Ä‘áº·t tá»± Ä‘á»™ng vá»›i UV Package Manager        â”‚
â”‚   ğŸ“… Updated: 07/07/2025 21:30 (GMT+7)             â”‚
â”‚                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
EOF
echo -e "${NC}"

# Show current time in Vietnam timezone
echo -e "${BLUE}ğŸ• Setup started at: $(TZ='Asia/Ho_Chi_Minh' date '+%d/%m/%Y %H:%M:%S %Z (GMT%z)')${NC}"

# Check OS
show_progress "Kiá»ƒm tra há»‡ Ä‘iá»u hÃ nh..."
if [[ "$OSTYPE" != "linux-gnu"* ]]; then
    show_error "Chá»‰ há»— trá»£ Linux! OS hiá»‡n táº¡i: $OSTYPE"
    exit 1
fi

OS_NAME=$(lsb_release -si 2>/dev/null || echo "Unknown")
OS_VERSION=$(lsb_release -sr 2>/dev/null || echo "Unknown")
show_info "OS: $OS_NAME $OS_VERSION"

# Check Python version
show_progress "Kiá»ƒm tra Python..."
if ! command -v python3 &> /dev/null; then
    show_error "Python3 khÃ´ng Ä‘Æ°á»£c tÃ¬m tháº¥y! Vui lÃ²ng cÃ i Ä‘áº·t Python 3.10+"
    exit 1
fi

PYTHON_VERSION=$(python3 -c 'import sys; print(".".join(map(str, sys.version_info[:2])))')
REQUIRED_VERSION="3.10"

if ! python3 -c "import sys; exit(0 if sys.version_info >= (3, 10) else 1)"; then
    show_error "YÃªu cáº§u Python $REQUIRED_VERSION+, nhÆ°ng tÃ¬m tháº¥y $PYTHON_VERSION"
    show_info "CÃ i Ä‘áº·t Python 3.10+:"
    echo "  sudo apt update"
    echo "  sudo apt install python3.10 python3.10-venv python3.10-dev"
    exit 1
fi

show_success "Python $PYTHON_VERSION Ä‘Ã£ sáºµn sÃ ng"

# Install UV if not exists
show_progress "CÃ i Ä‘áº·t UV Python Package Manager..."
if ! command -v uv &> /dev/null; then
    show_info "Äang táº£i UV..."
    curl -LsSf https://astral.sh/uv/install.sh | sh
    
    # Add to PATH for current session
    export PATH="$HOME/.cargo/bin:$PATH"
    
    # Add to shell profile
    if [[ -f "$HOME/.bashrc" ]]; then
        echo 'export PATH="$HOME/.cargo/bin:$PATH"' >> "$HOME/.bashrc"
    fi
    if [[ -f "$HOME/.zshrc" ]]; then
        echo 'export PATH="$HOME/.cargo/bin:$PATH"' >> "$HOME/.zshrc"
    fi
    
    show_success "UV Ä‘Ã£ Ä‘Æ°á»£c cÃ i Ä‘áº·t"
else
    show_success "UV Ä‘Ã£ cÃ³ sáºµn: $(uv --version)"
fi

# Create virtual environment
show_progress "Táº¡o Python Virtual Environment..."
ENV_NAME="pill-recognition-env"

# Remove existing env if exists
if [[ -d ".venv" ]]; then
    show_warning "MÃ´i trÆ°á»ng áº£o cÅ© Ä‘Ã£ tá»“n táº¡i, Ä‘ang xÃ³a..."
    rm -rf .venv
fi

# Create new environment
uv venv .venv --python 3.10
show_success "MÃ´i trÆ°á»ng áº£o Ä‘Ã£ Ä‘Æ°á»£c táº¡o: .venv"

# Activate environment
source .venv/bin/activate
show_success "ÄÃ£ kÃ­ch hoáº¡t mÃ´i trÆ°á»ng áº£o"

# Upgrade pip and install UV in venv
show_progress "Cáº­p nháº­t UV trong mÃ´i trÆ°á»ng áº£o..."
uv pip install --upgrade pip setuptools wheel

# Install dependencies
show_progress "CÃ i Ä‘áº·t dependencies tá»« pyproject.toml..."
if [[ -f "pyproject.toml" ]]; then
    uv pip install -e .
    show_success "Dependencies cá»‘t lÃµi Ä‘Ã£ Ä‘Æ°á»£c cÃ i Ä‘áº·t"
else
    show_warning "KhÃ´ng tÃ¬m tháº¥y pyproject.toml, cÃ i Ä‘áº·t tá»« requirements.txt..."
    if [[ -f "requirements.txt" ]]; then
        uv pip install -r requirements.txt
        show_success "Dependencies Ä‘Ã£ Ä‘Æ°á»£c cÃ i Ä‘áº·t tá»« requirements.txt"
    else
        show_error "KhÃ´ng tÃ¬m tháº¥y pyproject.toml hoáº·c requirements.txt!"
        exit 1
    fi
fi

# Check GPU support
show_progress "Kiá»ƒm tra há»— trá»£ GPU..."
if command -v nvidia-smi &> /dev/null; then
    GPU_INFO=$(nvidia-smi --query-gpu=name --format=csv,noheader,nounits 2>/dev/null | head -1)
    if [[ -n "$GPU_INFO" ]]; then
        show_success "GPU Ä‘Æ°á»£c phÃ¡t hiá»‡n: $GPU_INFO"
        
        # Install GPU dependencies
        show_progress "CÃ i Ä‘áº·t dependencies GPU..."
        uv pip install torch torchvision torchaudio --index-url https://download.pytorch.org/whl/cu121
        
        # Try to install CUDA accelerated packages
        show_progress "CÃ i Ä‘áº·t packages tÄƒng tá»‘c CUDA..."
        uv pip install cudf-cu12 cuml-cu12 cupy-cuda12x || {
            show_warning "KhÃ´ng thá»ƒ cÃ i Ä‘áº·t packages CUDA (bÃ¬nh thÆ°á»ng náº¿u khÃ´ng cÃ³ GPU phÃ¹ há»£p)"
        }
        
        show_success "CÃ i Ä‘áº·t GPU hoÃ n táº¥t"
    else
        show_warning "NVIDIA GPU khÃ´ng Ä‘Æ°á»£c phÃ¡t hiá»‡n"
    fi
else
    show_warning "nvidia-smi khÃ´ng tÃ¬m tháº¥y - Cháº¿ Ä‘á»™ CPU only"
fi

# Install development dependencies
show_progress "CÃ i Ä‘áº·t development tools..."
uv pip install pytest pytest-cov black isort flake8 jupyter

# Create necessary directories
show_progress "Táº¡o thÆ° má»¥c cáº§n thiáº¿t..."
mkdir -p data/{raw,processed} checkpoints logs results notebooks
show_success "ThÆ° má»¥c Ä‘Ã£ Ä‘Æ°á»£c táº¡o"

# Download test data (if available)
show_progress "Kiá»ƒm tra dá»¯ liá»‡u test..."
if [[ -d "Dataset_BigData/CURE_dataset" ]]; then
    show_success "Dataset CURE Ä‘Ã£ cÃ³ sáºµn"
else
    show_warning "Dataset CURE chÆ°a cÃ³ - vui lÃ²ng táº£i vá» vÃ  giáº£i nÃ©n vÃ o Dataset_BigData/"
fi

# Create activation script
show_progress "Táº¡o script kÃ­ch hoáº¡t mÃ´i trÆ°á»ng..."
cat > activate_env.sh << 'EOF'
#!/bin/bash
# KÃ­ch hoáº¡t mÃ´i trÆ°á»ng áº£o cho Pill Recognition System
echo "ğŸš€ KÃ­ch hoáº¡t mÃ´i trÆ°á»ng Pill Recognition..."
source .venv/bin/activate
echo "âœ… MÃ´i trÆ°á»ng Ä‘Ã£ sáºµn sÃ ng!"
echo "ğŸ’¡ Sá»­ dá»¥ng: ./bin/pill-cli hoáº·c ./bin/pill-web"
EOF
chmod +x activate_env.sh

# Test installation
show_progress "Kiá»ƒm tra cÃ i Ä‘áº·t..."
python -c "
import sys
print(f'âœ… Python: {sys.version}')

try:
    import torch
    print(f'âœ… PyTorch: {torch.__version__}')
    print(f'âœ… CUDA available: {torch.cuda.is_available()}')
    if torch.cuda.is_available():
        print(f'âœ… GPU: {torch.cuda.get_device_name(0)}')
except ImportError:
    print('âŒ PyTorch khÃ´ng kháº£ dá»¥ng')

try:
    import streamlit
    print(f'âœ… Streamlit: {streamlit.__version__}')
except ImportError:
    print('âŒ Streamlit khÃ´ng kháº£ dá»¥ng')

try:
    import pandas as pd
    import numpy as np
    from PIL import Image
    print('âœ… Data science packages available')
except ImportError:
    print('âŒ Má»™t sá»‘ data science packages thiáº¿u')
"

# Final setup
show_success "CÃ i Ä‘áº·t hoÃ n táº¥t!"

echo -e "\n${CYAN}ğŸ“‹ ThÃ´ng tin há»‡ thá»‘ng:${NC}"
echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
echo "ğŸ Python: $PYTHON_VERSION"
echo "ğŸ“¦ UV: $(uv --version)"
echo "ğŸ—‚ï¸  MÃ´i trÆ°á»ng: .venv"
echo "ğŸ’¾ ThÆ° má»¥c dá»± Ã¡n: $(pwd)"
echo "ğŸ• HoÃ n thÃ nh lÃºc: $(TZ='Asia/Ho_Chi_Minh' date '+%d/%m/%Y %H:%M:%S %Z (GMT%z)')"

if command -v nvidia-smi &> /dev/null && nvidia-smi &> /dev/null; then
    echo "ğŸ® GPU: $(nvidia-smi --query-gpu=name --format=csv,noheader,nounits | head -1)"
    echo "ğŸ”¥ CUDA: $(nvidia-smi --query-gpu=driver_version --format=csv,noheader,nounits | head -1)"
fi

echo -e "\n${GREEN}ğŸš€ CÃ¡ch sá»­ dá»¥ng:${NC}"
echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
echo "# KÃ­ch hoáº¡t mÃ´i trÆ°á»ng:"
echo "source .venv/bin/activate"
echo ""
echo "# Hoáº·c sá»­ dá»¥ng script:"
echo "./activate_env.sh"
echo ""
echo "# Cháº¡y á»©ng dá»¥ng:"
echo "./bin/pill-cli          # CLI interface"
echo "./bin/pill-web          # Web interface"
echo "python main.py --help   # Xem táº¥t cáº£ options"

echo -e "\n${YELLOW}ğŸ“š Documentation:${NC}"
echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
echo "ğŸ“– README.md           - HÆ°á»›ng dáº«n chÃ­nh"
echo "ğŸ“ docs/               - Documentation Ä‘áº§y Ä‘á»§"
echo "ğŸ¥ docs/DEMO_GUIDE.md  - HÆ°á»›ng dáº«n demo"

echo -e "\n${GREEN}âœ¨ ChÃºc báº¡n cÃ³ tráº£i nghiá»‡m tuyá»‡t vá»i vá»›i Pill Recognition System!${NC}"
